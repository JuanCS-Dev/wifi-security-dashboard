# WiFi Security Education Dashboard - Pre-commit Hooks
# Automates code quality checks before git commits
# Installation: pip install pre-commit && pre-commit install

repos:
  # General file checks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      # File formatting
      - id: trailing-whitespace
        name: Trim trailing whitespace
        description: Remove trailing whitespace from all files
      - id: end-of-file-fixer
        name: Fix end of files
        description: Ensure files end with newline
      - id: check-yaml
        name: Check YAML syntax
        description: Validate YAML files (config, workflows)
        files: \.(yaml|yml)$
      - id: check-toml
        name: Check TOML syntax
        description: Validate pyproject.toml
        files: \.toml$
      - id: check-json
        name: Check JSON syntax
        description: Validate JSON files
        files: \.json$
      - id: check-added-large-files
        name: Prevent large files
        description: Block files >1MB (prevents accidental binary commits)
        args: ['--maxkb=1024']
      - id: check-merge-conflict
        name: Check for merge conflicts
        description: Detect merge conflict markers
      - id: check-case-conflict
        name: Check filename case conflicts
        description: Prevent case-sensitivity issues
      - id: mixed-line-ending
        name: Normalize line endings
        description: Ensure consistent LF line endings
        args: ['--fix=lf']

      # Python-specific
      - id: check-ast
        name: Validate Python AST
        description: Ensure Python files parse correctly
        files: \.py$
      - id: check-docstring-first
        name: Check docstring position
        description: Ensure docstrings come before code
        files: \.py$
      - id: debug-statements
        name: Detect debug statements
        description: Block commits with pdb, ipdb, breakpoint()
        files: \.py$

  # Python code formatting (Black)
  - repo: https://github.com/psf/black
    rev: 24.1.1
    hooks:
      - id: black
        name: Format with Black
        description: Auto-format Python code (line-length=100)
        language_version: python3.10
        args: ['--line-length=100', '--target-version=py310']
        files: \.py$

  # Python import sorting (isort)
  - repo: https://github.com/PyCQA/isort
    rev: 5.13.2
    hooks:
      - id: isort
        name: Sort imports with isort
        description: Organize Python imports (black profile)
        args: ['--profile=black', '--line-length=100']
        files: \.py$

  # Python linting (flake8)
  - repo: https://github.com/PyCQA/flake8
    rev: 7.0.0
    hooks:
      - id: flake8
        name: Lint with flake8
        description: Check Python code quality
        args:
          - '--max-line-length=100'
          - '--extend-ignore=E203,W503'  # Black compatibility
          - '--exclude=.git,__pycache__,.venv,venv,build,dist'
        files: \.py$

  # Python type checking (mypy)
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.8.0
    hooks:
      - id: mypy
        name: Type check with mypy
        description: Static type checking for Python
        args:
          - '--ignore-missing-imports'
          - '--python-version=3.10'
          - '--no-strict-optional'
        files: ^src/.*\.py$
        additional_dependencies:
          - types-PyYAML
          - types-psutil

  # Security checks (bandit)
  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.6
    hooks:
      - id: bandit
        name: Security check with bandit
        description: Detect common security issues
        args:
          - '-r'
          - 'src/'
          - '-ll'  # Only report medium+ severity
          - '--skip=B101,B601'  # Skip assert and shell usage (acceptable in this project)
        pass_filenames: false

  # Shell script linting (shellcheck)
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.9.0.6
    hooks:
      - id: shellcheck
        name: Lint shell scripts
        description: Check bash scripts for errors
        files: \.(sh|bash)$
        args: ['--severity=warning']

  # Markdown linting (markdownlint)
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.38.0
    hooks:
      - id: markdownlint
        name: Lint Markdown files
        description: Check Markdown formatting
        args:
          - '--fix'
          - '--disable=MD013'  # Allow long lines (code blocks)
          - '--disable=MD033'  # Allow inline HTML
        files: \.md$

  # Validate Constituição Vértice compliance (custom)
  - repo: local
    hooks:
      - id: validate-p1-p6
        name: Validate P1-P6 Compliance
        description: Check Constituição Vértice v3.0 compliance
        entry: python3 tools/validate_constitution.py
        language: system
        pass_filenames: false
        always_run: true

      - id: calculate-metrics
        name: Calculate Metrics
        description: Calculate LEI, FPC, Coverage, CRS
        entry: python3 tools/calculate_metrics.py
        language: system
        pass_filenames: false
        stages: [push]  # Only on push, not commit

      - id: check-no-todos
        name: Check for TODO/FIXME
        description: Prevent commits with TODO/FIXME (P1: Completude Obrigatória)
        entry: 'grep -rn "TODO\|FIXME" src/ --exclude-dir=__pycache__'
        language: system
        pass_filenames: false
        # Set to fail if grep finds matches (exit code 0 means found)
        # Invert with '! grep' to fail on found
        entry: bash -c 'if grep -rn "TODO\|FIXME" src/ --exclude-dir=__pycache__; then exit 1; else exit 0; fi'

# Configuration
default_language_version:
  python: python3.10

# Stages
default_stages: [commit]

# Fail fast (stop on first failure)
fail_fast: false

# Exclude patterns
exclude: |
  (?x)^(
    \.git/.*|
    \.venv/.*|
    venv/.*|
    __pycache__/.*|
    \.pytest_cache/.*|
    \.mypy_cache/.*|
    build/.*|
    dist/.*|
    .*\.egg-info/.*
  )$
